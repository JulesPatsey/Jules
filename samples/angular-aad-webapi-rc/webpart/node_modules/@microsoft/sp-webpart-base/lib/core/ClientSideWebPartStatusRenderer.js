'use strict';
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var ReactDOM = require('react-dom');
var React = require('react');
var decorators_1 = require('@microsoft/decorators');
var odsp_utilities_bundle_1 = require('@ms/odsp-utilities-bundle');
var sp_telemetry_1 = require('@ms/sp-telemetry');
var sp_core_library_1 = require('@microsoft/sp-core-library');
var PlaceholderSpinner_1 = require('../components/placeHolder/PlaceholderSpinner');
var Strings_resx_1 = require('./loc/Strings.resx');
var cswp_base_module_scss_1 = require('./styles/cswp-base.module.scss');
var ClientSideWebPartStatusRenderer = (function () {
    function ClientSideWebPartStatusRenderer() {
        this._errorId = 'cswp-error';
        this._logSource = sp_telemetry_1._LogSource.create('ClientSideWebPartStatusRenderer');
        this._activeIndicatorCache = new Map();
    }
    ClientSideWebPartStatusRenderer.prototype.displayLoadingIndicator = function (domElement, loadingMessage, timeout) {
        var _this = this;
        sp_core_library_1.Validate.isNotNullOrUndefined(domElement, 'domElement');
        if (!this._activeIndicatorCache.has(domElement)) {
            if (!isNaN(timeout)) {
                timeout = 900; 
            }
            var loadingTimer = window.setTimeout(function () {
                if (!_this._isErrorBeingRendered) {
                    sp_telemetry_1._TraceLogger.logVerbose(_this._logSource, Strings_resx_1.default.DisplayLoadingIndicator);
                    var el = React.createElement(PlaceholderSpinner_1.default, { label: odsp_utilities_bundle_1.StringHelper.format(Strings_resx_1.default.LoadingStatus, loadingMessage) });
                    _this._placeholder = ReactDOM.render(el, domElement);
                }
            }, timeout);
            this._activeIndicatorCache.set(domElement, loadingTimer);
        }
    };
    ClientSideWebPartStatusRenderer.prototype.clearLoadingIndicator = function (domElement) {
        sp_core_library_1.Validate.isNotNullOrUndefined(domElement, 'domElement');
        var loadingTimer = this._activeIndicatorCache.get(domElement);
        if (loadingTimer) {
            sp_telemetry_1._TraceLogger.logVerbose(this._logSource, Strings_resx_1.default.ClearLoadingIndicator);
            window.clearTimeout(loadingTimer);
            this._activeIndicatorCache.delete(domElement);
            if (this._placeholder) {
                this._placeholder.showSpinner(false);
            }
        }
    };
    ClientSideWebPartStatusRenderer.prototype.renderError = function (domElement, error) {
        this._isErrorBeingRendered = true;
        sp_core_library_1.Validate.isNotNullOrUndefined(domElement, 'domElement');
        sp_core_library_1.Validate.isNotNullOrUndefined(error, 'error');
        var divErr = domElement.querySelector("div[data-sp-id='" + this._errorId + "']");
        if (divErr) {
            divErr.style.display = 'block';
        }
        else {
            if (!this._errorHtml) {
                this._errorHtml =
                    ("<div class='" + cswp_base_module_scss_1.default.errorBox + "' role='alert' aria-live='assertive'>") +
                        ("<span class='" + cswp_base_module_scss_1.default.errorBoxText + "'></span>") +
                        "</div>";
            }
            divErr = document.createElement('div');
            divErr.setAttribute('data-sp-id', this._errorId);
            divErr.setAttribute('data-automation-id', 'webPartError');
            divErr.innerHTML = this._errorHtml;
            domElement.appendChild(divErr);
        }
        var text = divErr.getElementsByTagName('span')[0];
        var errorText = '';
        if (error instanceof sp_core_library_1.SPError) {
            errorText = error.toStringForUI();
        }
        else {
            errorText += "" + (error.message || error);
            if (DEBUG && error.stack) {
                errorText += " CALLSTACK:: " + error.stack;
            }
        }
        text.textContent = errorText;
    };
    ClientSideWebPartStatusRenderer.prototype.clearError = function (domElement) {
        this._isErrorBeingRendered = false;
        sp_core_library_1.Validate.isNotNullOrUndefined(domElement, 'domElement');
        var divErr = domElement.querySelector("div[data-sp-id='" + this._errorId + "']");
        if (divErr) {
            divErr.style.display = 'none';
            divErr.removeAttribute('data-automation-id');
        }
    };
    ClientSideWebPartStatusRenderer = __decorate([
        decorators_1.sealed
    ], ClientSideWebPartStatusRenderer);
    return ClientSideWebPartStatusRenderer;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = ClientSideWebPartStatusRenderer;
