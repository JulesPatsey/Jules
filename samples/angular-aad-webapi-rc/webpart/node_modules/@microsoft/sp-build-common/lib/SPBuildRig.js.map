{"version":3,"sources":["SPBuildRig.ts"],"names":[],"mappings":"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","file":"SPBuildRig.js","sourcesContent":["/// <reference path=\"./../typings/tsd.d.ts\" />\r\n\r\nimport * as path from 'path';\r\nimport * as gulp from 'gulp';\r\nimport * as yargs from 'yargs';\r\n\r\nimport * as coreBuild from '@microsoft/gulp-core-build';\r\n\r\nimport { initializeTslintTask } from '@microsoft/sp-tslint-rules';\r\nimport { typescript, tslint, removeTripleSlash } from '@microsoft/gulp-core-build-typescript';\r\n\r\nimport { BuildRig, IConfigurableTask, ITaskDefinition, ICoreBuildArgs } from './BuildRig';\r\nimport { BuildRigConstants } from './BuildRigConstants';\r\n\r\nexport const preCopy: coreBuild.CopyTask = new coreBuild.CopyTask();\r\nexport const postCopy: coreBuild.CopyTask = new coreBuild.CopyTask();\r\n\r\nexport interface ISPBuildRigArgs extends ICoreBuildArgs {\r\n  /**\r\n   * All SPFx build rigs can be tested in a specific locale using this flag,\r\n   * which is defined in the localization code\r\n   *\r\n   * @todo 253519 remove this once this logic is in GCB/the Task definition\r\n   */\r\n  locale: string;\r\n}\r\n\r\n/**\r\n * Helper function to ensure that the schemas from this directory are loaded\r\n */\r\nfunction getSchemaFilePath(filename: string): string {\r\n  return path.join(__dirname, 'schemas', filename);\r\n}\r\n\r\n/**\r\n * This class represents the basic shared build rig for all SPFx Rigs. It defines a few\r\n * simple sub-tasks, and only registers a \"build\" task.\r\n */\r\nexport class SPBuildRig extends BuildRig {\r\n  protected _preBuildTasks: coreBuild.IExecutable[] = [];\r\n  protected _postTypescriptTasks: coreBuild.IExecutable[] = [];\r\n  protected _postBuildTasks: coreBuild.IExecutable[] = [];\r\n\r\n  public initialize(gulp: gulp.Gulp): void {\r\n    super.initialize(gulp);\r\n  }\r\n\r\n  /**\r\n   * Register additional sub-tasks to run before the typescript subtask.\r\n   * Note, this is meant to be used in a gulpfile.js to inject one-off subtasks\r\n   */\r\n  public addPreBuildTask(tasks: coreBuild.IExecutable | coreBuild.IExecutable[]): void {\r\n    this._addTaskOrListOfTasks(tasks, this._preBuildTasks);\r\n  }\r\n\r\n  /**\r\n   * Register additional sub-tasks to run after the typescript subtask.\r\n   * Note, this is meant to be used in a gulpfile.js to inject one-off subtasks\r\n   */\r\n  public addPostTypescriptTask(tasks: coreBuild.IExecutable | coreBuild.IExecutable[]): void {\r\n    this._addTaskOrListOfTasks(tasks, this._postTypescriptTasks);\r\n  }\r\n\r\n  /**\r\n   * Register additional sub-tasks to run after the typescript subtask.\r\n   * @deprecated\r\n   */\r\n  public addBuildTasks(tasks: coreBuild.IExecutable | coreBuild.IExecutable[]): void {\r\n    this._addTaskOrListOfTasks(tasks, this._postTypescriptTasks);\r\n  }\r\n\r\n  /**\r\n   * Register additional sub-tasks to run after the entire build.\r\n   * Note, this is meant to be used in a gulpfile.js to inject one-off subtasks\r\n   */\r\n  public addPostBuildTask(tasks: coreBuild.IExecutable | coreBuild.IExecutable[]): void {\r\n    this._addTaskOrListOfTasks(tasks, this._postBuildTasks);\r\n  }\r\n\r\n  /**\r\n   * Register the custom configurations\r\n   * @todo 253526 this code should be pushed into gulp-core-build\r\n   */\r\n  protected getCustomConfigs(): Array<IConfigurableTask> {\r\n    return super.getCustomConfigs().concat([\r\n      {\r\n        callback: preCopy.mergeConfig.bind(preCopy),\r\n        configFile: 'pre-copy.json',\r\n        readmeUrl: 'https://github.com/Microsoft/gulp-core-build/blob/master/src/CopyTask.ts',\r\n        schemaFile: getSchemaFilePath('copy.schema.json')\r\n      },\r\n      {\r\n        callback: postCopy.mergeConfig.bind(postCopy),\r\n        configFile: 'post-copy.json',\r\n        readmeUrl: 'https://github.com/Microsoft/gulp-core-build/blob/master/src/CopyTask.ts',\r\n        schemaFile: getSchemaFilePath('copy.schema.json')\r\n      },\r\n      {\r\n        callback: typescript.setConfig.bind(typescript),\r\n        configFile: 'typescript.json',\r\n        readmeUrl: 'https://github.com/Microsoft/gulp-core-build-typescript/blob/master/src/TypeScriptTask.ts',\r\n        schemaFile: getSchemaFilePath('typescript.schema.json')\r\n      },\r\n      {\r\n        callback: tslint.mergeConfig.bind(tslint),\r\n        configFile: 'tslint.json',\r\n        readmeUrl: 'https://github.com/Microsoft/gulp-core-build-typescript/blob/master/src/TSLintTask.ts',\r\n        schemaFile: getSchemaFilePath('tslint.schema.json')\r\n      }\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * Registers the command line arguments which are available for this rig\r\n   * @todo 253519 this code should be moved into gulp-core-build/the task definitions\r\n   */\r\n  protected getYargs(): yargs.Argv {\r\n    return super.getYargs()\r\n      .option('locale', {\r\n        alias: 'l',\r\n        describe: 'override the default culture (e.g. \"fr-fr\")',\r\n        string: true\r\n      })\r\n      .command(BuildRigConstants.tasks.build, 'build the project')\r\n      .command(BuildRigConstants.tasks.default, 'equivalent to bundle');\r\n  }\r\n\r\n  /**\r\n   * Register 2 tasks, build and default, which simply copy files, then run typescript and tslint\r\n   */\r\n  protected getTasks(): Map<string, ITaskDefinition> {\r\n    const result: Map<string, ITaskDefinition> = new Map<string, ITaskDefinition>();\r\n\r\n    result.set(BuildRigConstants.tasks.build, { executable: this.getBuildTask() });\r\n    result.set(BuildRigConstants.tasks.default, { executable: this.getBuildTask() });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Override this function to overwrite the \"build\" task\r\n   */\r\n  protected getBuildTask(): coreBuild.IExecutable {\r\n    return coreBuild.serial(\r\n             preCopy,\r\n             coreBuild.serial(this._preBuildTasks),\r\n             this.getCoreBuildTask(),\r\n             coreBuild.serial(this._postBuildTasks),\r\n             postCopy);\r\n  }\r\n\r\n  /**\r\n   * Override this function to redefine the core build loop\r\n   */\r\n  protected getCoreBuildTask(): coreBuild.IExecutable {\r\n    return coreBuild.parallel(\r\n      tslint,\r\n      coreBuild.serial(\r\n        coreBuild.serial(typescript, removeTripleSlash),\r\n        coreBuild.serial(...this._postTypescriptTasks)\r\n      )\r\n    );\r\n  }\r\n\r\n  protected setupSharedConfig(): void {\r\n    // Ensure that the SPFx tslint rules are activated\r\n    initializeTslintTask(tslint);\r\n\r\n    tslint.mergeConfig({\r\n      displayAsWarning: true\r\n    });\r\n\r\n    // @todo the typescript compiler should be specified here\r\n\r\n    preCopy.name = 'pre-copy';\r\n    postCopy.name = 'post-copy';\r\n  }\r\n\r\n  /**\r\n   * This function cleans up the shared config by populating task config properties that depend on other tasks'\r\n   *  user-defined properties.\r\n   */\r\n  protected finalizeSharedConfig(): void { /* no-op */ }\r\n\r\n  private _addTaskOrListOfTasks(tasks: coreBuild.IExecutable | coreBuild.IExecutable[],\r\n                                array: coreBuild.IExecutable[]): void {\r\n    if ((tasks as coreBuild.IExecutable[]).length) {\r\n      array.push(...(tasks as coreBuild.IExecutable[]));\r\n    } else {\r\n      array.push(tasks as coreBuild.IExecutable);\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":"/src"}